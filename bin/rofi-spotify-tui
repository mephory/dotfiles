#!/bin/sh

mkdir -p "$HOME/.cache/rofi-spotify-tui"
touch "$HOME/.cache/rofi-spotify-tui/history"
if [[ ! -e "$HOME/.cache/rofi-spotify-tui/playlists" ]]; then
  spt list --playlists > "$HOME/.cache/rofi-spotify-tui/playlists"
fi

SELECTED="$(tac "$HOME/.cache/rofi-spotify-tui/history" "$HOME/.cache/rofi-spotify-tui/playlists" | rofi -i -dmenu)"
if [[ ! "$SELECTED" ]]; then
  exit
fi

URI="$(echo $SELECTED | grep -oP '(?<=\().*(?=\)$)')"

if [[ "$?" -ne "0" ]]; then
  RESULTS="$(spt search --tracks "$SELECTED" --limit 50)"
  SELECTED="$(echo "$RESULTS" | rofi -i -dmenu)"
  URI="$(echo $SELECTED | grep -oP '(?<=\().*(?=\)$)')"
fi

if [[ ! "$URI" ]]; then
  exit
fi

spt play --track --uri "$URI"

if [[ "$SELECTED" ]]; then
  NEW_HISTORY="$(cat <(tail -n49 "$HOME/.cache/rofi-spotify-tui/history") <(echo "$SELECTED"))"
  echo "$NEW_HISTORY" > $HOME/.cache/rofi-spotify-tui/history
fi
